<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html" ; charset="utf-8"/>
    <title></title>
    <link href="static/js/bstable/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="static/css/table.css" rel="stylesheet" type="text/css">
    <link href="static/css/baidu.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="static/js/artDialog/skins/default.css" type="text/css"/>
    <link href="static/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" type="text/css" />
    <style>
    *{ margin:0; padding:0; list-style:none;}
    a{ text-decoration:none;}
    a:hover{ text-decoration:none;}
    .tcdPageCode{padding: 15px 20px;text-align: left;color: #ccc;}
    .tcdPageCode a{display: inline-block;color: #428bca;display: inline-block;height: 25px;	line-height: 25px;	padding: 0 10px;border: 1px solid #ddd;	margin: 0 2px;border-radius: 4px;vertical-align: middle;}
    .tcdPageCode a:hover{text-decoration: none;border: 1px solid #428bca;}
    .tcdPageCode span.current{display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;color: #fff;background-color: #428bca;	border: 1px solid #428bca;border-radius: 4px;vertical-align: middle;}
    .tcdPageCode span.disabled{	display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;	color: #bfbfbf;background: #f2f2f2;border: 1px solid #bfbfbf;border-radius: 4px;vertical-align: middle;}
    </style>
</head>
<body style="background-color: #ecf0f5;font-family: 微软雅黑;color: #475059;min-width: 1000px;overflow: auto;">
<div class="notice_main" style="background-color: #ccc">
    <div class="myMap_left l_left">

        <div class="map" id="allmap"></div>
        <div class="notice">
            <p id="weather"></p>

            <div class="map_btn"><span class="glyphicon glyphicon-fullscreen first"></span><span class="two">全屏</span>
            </div>
            <div class="map_btn"><span class="glyphicon glyphicon-wrench first"></span><span class="two">工具</span></div>
            <div class="map_btn"><span class="glyphicon glyphicon-search first"></span><span class="two">搜索</span></div>

            <div class="map_btn"><span class="glyphicon glyphicon-screenshot first"></span><span class="two">对比</span>
            </div>
            <div class="map_btn"><span class="glyphicon glyphicon-zoom-out first"></span><span class="two">放大</span>
            </div>
            <div class="map_btn"><span class="glyphicon glyphicon-zoom-in first"></span><span class="two">缩小</span>
            </div>
            <div class="map_btn"><span class="glyphicon glyphicon-pencil first"></span><span class="two">图层选择</span>
            </div>

        </div>
<!--        <div class="bill">-->
<!--            <p>功能菜单<span class="glyphicon glyphicon-chevron-up" id="listDown" onClick="listDown()"></span><span class="glyphicon glyphicon-chevron-down" id="listUp" onClick="listUp()" style="display: none"></span></p>-->
<!--            <ul style="background-color: rgb(84, 122, 169)" class="list">-->
<!--                <li>-->
<!--                    <input type="checkbox" name="person"><span>路灯</span>-->
<!--                    <div class="clear"></div>-->
<!--                </li>-->

<!--                <li>-->
<!--                    <input type="checkbox" name="video"><span>摄像头</span>-->
<!--                    <div class="clear"></div>-->
<!--                </li>-->
<!--                <li>-->
<!--                    <input type="checkbox" name="hot"><span>热力图</span>-->
<!--                    <div class="clear"></div>-->
<!--                </li>-->
<!--            </ul>-->
<!--        </div>-->
    </div>
    <div class="myMap_right l_left">
        <h6>区域目录</h6>
        <div class="tree_left_top">
            <div class=" order_ztree l_left organize_ztree" style="width: 100%">
                <p><ul id="treeDemo" class="ztree"  style=" overflow:auto;margin-left: 20px"></ul></p>
            </div>
        </div>
    </div>
</div>

<div class="content"></div>
<div class="wrench content">
</div>
<div class="search content">
    <input type="text">
    <button class="glyphicon glyphicon-search"></button>
</div>
<script src="http://www.lanrenzhijia.com/ajaxjs/jquery.min.js"></script>
<script src="http://www.lanrenzhijia.com/ajaxjs/jquery.page.js"></script>
<script src="static/js/bstable/js/bootstrap.min.js"></script>
<script src="static/js/bstable/js/bootstrap-table.js"></script>
<script src="static/js/bstable/js/bootstrap-table-zh-CN.min.js"></script>
<script src="static/js/artDialog/artDialog.js"></script>
<script src="static/js/artDialog/plugins/iframeTools.source.js"></script>
<script type="text/javascript" src="static/js/ztree/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="static/js/ztree/jquery.ztree.excheck-3.5.js"></script>
<script type="text/javascript" src="static/js/ztree/jquery.ztree.exedit-3.5.js"></script>
<script src="static/js/listTree.js"></script>
<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=5ieMMexWmzB9jivTq6oCRX9j"></script>
<script type="text/javascript"
        src="https://api.map.baidu.com/library/AreaRestriction/1.2/src/AreaRestriction_min.js"></script>
<script type="text/javascript"
        src="https://api.map.baidu.com/library/RectangleZoom/1.2/src/RectangleZoom_min.js"></script>
<script type="text/javascript"
        src="https://api.map.baidu.com/library/TextIconOverlay/1.2/src/TextIconOverlay_min.js"></script>
<script type="text/javascript"
        src="https://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<!--车辆轨迹-->
<script type="text/javascript"
        src="https://api.map.baidu.com/library/LuShu/1.2/src/LuShu_min.js"></script>
<!--热力图-->
<script type="text/javascript"
        src="https://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
<script src="static/js/baidu.js"></script>
<script type="text/javascript">

    var zTree, rMenu;
    var marker = undefined;
    var label = undefined;
    $(document).ready(function(){
        $.fn.zTree.init($("#treeDemo"), getSettting(), getMenuTree());

        zTree = $.fn.zTree.getZTreeObj("treeDemo");
        rMenu = $("#rMenu");
    });

    function theLocation(id){


        map.clearOverlays();
        var new_point;
        if(id ==1 ){
            new_point = new BMap.Point(116.32490 , 39.80739  );
            var polyline = new BMap.Polyline([
                new BMap.Point(116.32535 , 39.79937 ),
                new_point,
                new BMap.Point(116.32442 , 39.81439 )
            ], {
                strokeColor: 'black',
                strokeWeight: 4,
                strokeOpacity: 0.5
            });


        }else {
            new_point = new BMap.Point(116.42490 , 39.90739  );
            var polyline = new BMap.Polyline([
                new BMap.Point(116.42535 , 39.89937 ),
                new_point,
                new BMap.Point(116.42442 , 39.91439 )
            ], {
                strokeColor: 'red',
                strokeWeight: 4,
                strokeOpacity: 0.5
            });


        }
        map.addOverlay(polyline);
        map.panTo(new_point);

    }

    $(".map_btn").each(function (index) {
        $(this).click(function () {
            if ($(this).is('.color')) {
                $(this).removeClass("color");
                $(".content").eq(index).slideUp()
            } else {
                $(".map_btn").removeClass("color");
                $(this).addClass("color");
                $(".content").eq(index).slideDown().siblings(".content").slideUp()
            }

        })
    });

    $(".myMapNav ul li").each(function (index) {
        $(this).click(function () {
            $(this).addClass("liActive").siblings("li").removeClass("liActive");
            $(".myMapContent .box").eq(index).show().siblings("div").hide().stop()
        })
    });

    $(".specialNav ul li").each(function (index) {
        $(this).click(function () {
            $(".specialNav").hide();
            $(".specialInformation").eq(index).show().siblings(".specialInformation").hide()
        })
    });


    function back() {
        $(".specialInformation").hide();
        $(".specialNav").show()
    }

    function listDown(){
        $("#listDown").hide();
        $("#listUp").show();
        $(".list").slideUp();
    }
    function listUp(){
        $("#listUp").hide();
        $("#listDown").show();
        $(".list").slideDown();
    }

    function getMenuTree() {
        var root = {
            id : 0,
            name : "所有区域",
            open : true,
        };

        $.ajax({
            type : 'get',
            url : '/area/all',
            contentType : "application/json; charset=utf-8",
            async : false,
            success : function(data) {
                var length = data.length;
                var children = [];
                for (var i = 0; i < length; i++) {
                    var d = data[i];
                    var node = createNode(d);
                    children[i] = node;
                }

                root.children = children;
                console.log(root);
            }
        });

        return root;
    }

    function initMenuDatas(roleId){
        $.ajax({
            type : 'get',
            url : '/permissions?roleId=' + roleId,
            success : function(data) {
                var length = data.length;
                var ids = [];
                for(var i=0; i<length; i++){
                    ids.push(data[i]['id']);
                }

                initMenuCheck(ids);
            }
        });
    }

    function initMenuCheck(ids) {
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
        var length = ids.length;
        if(length > 0){
            var node = treeObj.getNodeByParam("id", 0, null);
            treeObj.checkNode(node, true, false);
        }

        for(var i=0; i<length; i++){
            var node = treeObj.getNodeByParam("id", ids[i], null);
            treeObj.checkNode(node, true, false);
        }

    }

    function getCheckedMenuIds(){
        var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
        var nodes = treeObj.getCheckedNodes(true);

        var length = nodes.length;
        var ids = [];
        for(var i=0; i<length; i++){
            var n = nodes[i];
            var id = n['id'];
            ids.push(id);
        }

        return ids;
    }

    function createNode(d) {
        var id = d['areaId'];
        var pId = d['parentId'];
        var name = d['areaName'];
        var net = d['areaNet'];
        var child = d['child'];

        var node = {
            open : true,
            id : id,
            name : name,
            pId : pId,
            net : net,
        };

        if (child != null) {
            var length = child.length;
            if (length > 0) {
                var children = [];
                for (var i = 0; i < length; i++) {
                    children[i] = createNode(child[i]);
                }

                node.children = children;
            }

        }
        return node;
    }

    function initParentMenuSelect(areaLevel){
        $.ajax({
            type : 'get',
            url : '/permissions/parents/' + areaLevel,
            async : false,
            success : function(data) {
                var select = $("#parentId");
                select.append("<option value='0'>root</option>");
                for(var i=0; i<data.length; i++){
                    var d = data[i];
                    var id = d['areaId'];
                    var name = d['areaName'];

                    select.append("<option value='"+ id +"'>" +name+"</option>");
                }
            }
        });
    }

    function getSettting() {
        var setting = {
//		check : {
//			enable : true,
//			chkboxType : {
//				"Y" : "ps",
//				"N" : "ps"
//			}
//		},
            async : {
                enable : true,
            },
            data : {
                simpleData : {
                    enable : true,
                    idKey : "id",
                    pIdKey : "pId",
                    rootPId : 0
                }
            },
            callback : {
                onClick : zTreeOnCheck
            }
        };

        return setting;
    }

    function zTreeOnCheck(event, treeId, treeNode) {
        var parentNodes = getPath(treeNode);
        var pathNames = [];
        // 打印所有父节点的id和name
        for (var i = 1; i < parentNodes.length; i++) {
            pathNames.push(parentNodes[i].name);
        }
        pathNames.push(treeNode.name);

        var pathLen = pathNames.length;
        var pathName = pathNames.join("");
        console.log(pathName);
        //document.getElementById("path").innerText  = "当前目录：" + pathName;//修改~·#

        geocodeLocation(pathName,pathLen);



        if(!treeNode.isParent){//到达最底层，路段信息


        } else {//父节点

            if( treeNode.id == 0 ){   //所有区域，待定，之后实现数据库获取区域功能



            } else {

                var childNodes = zTree.transformToArray(treeNode);
                var deviceCoordList = new Array();
                for(i = 0; i < childNodes.length; i++) {
                    deviceCoordList[i] = childNodes[i].net;
                    //do something——去除undefined


                }



            }

        }
    }

    function getPath(treeNode) {
        // 获取子节点的所有父节点
        var parentNodes = [];
        var parentNode = treeNode.getParentNode();
        while (parentNode !== null) {
            parentNodes.unshift(parentNode);//在数组的开头添加一个或多个元素
            parentNode = parentNode.getParentNode();
        }
        return parentNodes;
    }

    function geocodeLocation(pathName, pathLen) {
        var apiUrl = "http://api.map.baidu.com/geocoding/v3/";
        var apiKey = "5IoEK2HdiSizcKZ9l7Wr49ycDEPCGiIk"
        var requestUrl = apiUrl + "?address=" + encodeURIComponent(pathName) + "&output=json&ak=" + apiKey;

        // 发送JSONP请求
        $.ajax({
            url: requestUrl,
            dataType: 'jsonp',
            success: function(data) {
                // 解析 API 返回结果，提取经纬度信息
                var status = data.status;
                if (status === 0) {
                    var result = data.result;
                    var location = result.location;
                    var longitude = location.lng;//经度
                    var latitude = location.lat;//纬度

                    console.log(longitude);
                    console.log(latitude);
                    if (marker !== undefined) {
                        map.removeOverlay(marker);
                    }
                    // 在地图上标记该地点
                    var newPoint = new BMap.Point(longitude, latitude);
                    var location_id = longitude.toFixed(2)+","+latitude.toFixed(2);
                    console.log(location_id);
                    getWeather(pathName,location_id);
                    var zoomLevel = getZoomLevelByPathLen(pathLen);
                    map.centerAndZoom(newPoint, zoomLevel);
                    // 创建标注物
                    marker = new BMap.Marker(newPoint);
                    // 将标注物添加到地图上
                    map.addOverlay(marker);
                    // 将地图中心移动到标注点
                    map.panTo(newPoint);

                    var opts = {
                        position: newPoint, // 指定文本标注所在的地理位置
                        offset: new BMap.Size(30, -30) // 设置文本偏移量
                    };
                    var content = '此处为文本标注';
                    if (label !== undefined) {
                        map.removeOverlay(label);
                    }
                    label = new BMap.Label(content, opts);
                    // 自定义文本标注样式
                    label.setStyle({
                        color: 'blue',
                        borderRadius: '5px',
                        borderColor: '#ccc',
                        padding: '10px',
                        fontSize: '16px',
                        height: '30px',
                        lineHeight: '20px',
                        fontFamily: '微软雅黑',

                    });

                    map.addOverlay(label);

                } else {
                    console.log("地理编码失败");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("请求地理编码服务出错:", textStatus, errorThrown);
            }
        });
    }

    function getZoomLevelByPathLen(pathLen) {
        var zoomLevel;
        if (pathLen === 1) {
            zoomLevel = 5; // 省级别的缩放级别
        } else if (pathLen === 2) {
            zoomLevel = 10; // 城市级别的缩放级别
        } else if (pathLen === 3){
            zoomLevel = 15; // 区县的缩放级别
        } else {
            zoomLevel = 18; //街道
        }
        return zoomLevel;
    }


    function getWeather(pathName,location_id) {
        var apiUrl = "https://devapi.qweather.com/v7/weather/now";
        var key = "c6029580da13485089c99793330c83f1";
        var requestUrl = apiUrl + "?location=" + location_id + "&key=" + key;

        // 发送JSONP请求
        $.ajax({
            url: requestUrl,
            dataType: 'json',
            success: function(response) {
                console.log(response.code);
                if (response.code === "200") {
                    var temperature = response.now.temp;
                    var weather = response.now.text;
                    console.log(temperature);
                    console.log(weather);
                    var weatherInfo= pathName +"\u0020\u0020\u0020\u0020\u0020\u0020"+ weather + "\u0020\u0020\u0020\u0020\u0020\u0020" + temperature + "\u2103";
                    document.getElementById("weather").innerText  = weatherInfo;//修改~·#
                } else {
                    console.log("天气信息查询失败");
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("天气信息查询服务出错:", textStatus, errorThrown);
            }
        });
    }

</script>

</body>
</html>
